<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:fragment="dynamic(view)">
    <head>
        <meta charset="UTF-8">
        <title>Tech Store - H·ªá th·ªëng b√°n h√†ng c√¥ng ngh·ªá</title>
        
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
        
        <style>
            /* ================= CSS MENU (ƒê√É ƒê·ªîI SANG M√ÄU XANH) ================= */
            .navbar-nav .nav-link {
                transition: all 0.3s ease;
                position: relative;
                font-weight: 600;
                color: #555; /* M√†u ch·ªØ m·∫∑c ƒë·ªãnh t·ªëi h∆°n ch√∫t cho r√µ */
            }
            
            /* Hover v√†o ƒë·ªïi th√†nh m√†u Xanh D∆∞∆°ng (thay v√¨ V√†ng) */
            .navbar-nav .nav-link:hover { color: #0d6efd !important; }
            
            /* Trang ƒëang ch·ªçn (Active) m√†u Xanh D∆∞∆°ng */
            .active-nav { color: #0d6efd !important; font-weight: bold !important; }
            
            /* G·∫°ch ch√¢n d∆∞·ªõi ch·ªØ c≈©ng m√†u Xanh D∆∞∆°ng */
            .navbar-nav .nav-link::after {
                content: ''; position: absolute; bottom: 5px; left: 50%;
                width: 0; height: 3px;
                background-color: #0d6efd; /* M√†u xanh */
                transition: all 0.3s ease-in-out; transform: translateX(-50%);
                border-radius: 2px;
            }
            .navbar-nav .nav-link:hover::after, .active-nav::after { width: 80%; }

            /* ================= CSS CHATBOX WIDGET ================= */
            
            /* N√∫t tr√≤n b·∫≠t chat */
            .chat-btn-toggle {
                position: fixed; bottom: 25px; right: 90px; /* C√°ch l·ªÅ ph·∫£i 90px ƒë·ªÉ n√© n√∫t BackToTop */
                width: 55px; height: 55px;
                background: linear-gradient(135deg, #0084ff, #0056b3);
                color: white; border-radius: 50%;
                display: flex; align-items: center; justify-content: center;
                cursor: pointer; box-shadow: 0 4px 12px rgba(0, 132, 255, 0.4);
                z-index: 99999; transition: transform 0.2s;
            }
            .chat-btn-toggle:hover { transform: scale(1.1); }
            
            /* Ch·∫•m ƒë·ªè th√¥ng b√°o tin m·ªõi */
            .notification-dot {
                position: absolute; top: 0; right: 0;
                width: 14px; height: 14px; background-color: #ff3b30;
                border: 2px solid white; border-radius: 50%; display: none;
            }

            /* Khung Chat ch√≠nh */
            .chat-box {
                position: fixed; bottom: 95px; right: 25px;
                width: 360px; height: 520px;
                background: white; border-radius: 18px;
                box-shadow: 0 5px 40px rgba(0,0,0,0.16);
                z-index: 99999; display: none;
                flex-direction: column; overflow: hidden;
                border: 1px solid rgba(0,0,0,0.08);
                font-family: Helvetica, Arial, sans-serif;
                animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }

            @keyframes popUp {
                from { opacity: 0; transform: translateY(20px) scale(0.9); }
                to { opacity: 1; transform: translateY(0) scale(1); }
            }

            /* Header Chat */
            .chat-header {
                background: white; padding: 15px;
                display: flex; align-items: center; justify-content: space-between;
                border-bottom: 1px solid #f0f0f0;
                box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            }
            .chat-title { font-weight: 700; color: #050505; font-size: 1.1rem; }
            .chat-subtitle { font-size: 0.75rem; color: #65676b; display: flex; align-items: center; gap: 5px; }
            .online-dot { width: 8px; height: 8px; background: #31a24c; border-radius: 50%; }

            /* Tabs ch·ªçn AI/Nh√¢n vi√™n */
            .chat-tabs {
                display: flex; background: #f0f2f5; padding: 4px; margin: 10px 10px 0 10px;
                border-radius: 10px;
            }
            .chat-tab-btn {
                flex: 1; border: none; background: transparent; padding: 8px;
                font-size: 0.85rem; font-weight: 600; color: #65676b;
                border-radius: 8px; transition: all 0.2s;
            }
            .chat-tab-btn.active { background: white; color: #0084ff; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
            .chat-tab-btn:hover:not(.active) { background: rgba(0,0,0,0.05); }

            /* Khu v·ª±c n·ªôi dung */
            .tab-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
            .chat-pane { flex: 1; display: flex; flex-direction: column; height: 100%; display: none; }
            .chat-pane.active { display: flex; }
            
            .messages-area {
                flex: 1; padding: 15px; overflow-y: auto;
                display: flex; flex-direction: column; gap: 8px;
            }

            /* Bong b√≥ng tin nh·∫Øn */
            .msg {
                max-width: 75%; padding: 8px 12px; border-radius: 18px;
                font-size: 0.9rem; line-height: 1.4; word-wrap: break-word;
                position: relative;
            }
            .msg.sender { align-self: flex-end; background-color: #0084ff; color: white; }
            .msg.receiver { align-self: flex-start; background-color: #e4e6eb; color: #050505; }

            /* Khu v·ª±c nh·∫≠p li·ªáu */
            .input-area {
                padding: 10px 15px 15px 15px; border-top: 1px solid #f0f0f0;
                display: flex; align-items: center; gap: 8px;
            }
            .input-box {
                flex: 1; background: #f0f2f5; border: none;
                border-radius: 20px; padding: 10px 15px; outline: none;
                font-size: 0.95rem; transition: background 0.2s;
            }
            .input-box:focus { background: #e4e6eb; }
            
            .send-btn-icon {
                color: #0084ff; font-size: 20px; cursor: pointer;
                background: none; border: none; padding: 5px;
                transition: transform 0.2s;
            }
            .send-btn-icon:hover { transform: scale(1.1); }

            /* Hi·ªáu ·ª©ng ƒëang nh·∫≠p */
            .typing-dot {
                display: none; margin-left: 15px; margin-bottom: 5px; font-size: 12px; color: #65676b; font-style: italic;
            }
        </style>
    </head>
    <body>
        
        <div th:replace="~{/layout/fragments :: header}"></div>
        
        <div class="container mt-4 mb-4" style="min-height: 600px">
            <div th:replace="${view}"></div>
        </div>
        
        <div th:replace="~{/layout/fragments :: footer}"></div>
        
        <div>
            <div class="chat-btn-toggle" onclick="toggleChat()" title="Chat ngay">
                <i class="bi bi-chat-fill" id="toggleIcon"></i>
                <div class="notification-dot" id="notiDot"></div>
            </div>
            
            <div class="chat-box" id="chatBox">
                <div class="chat-header">
                    <div>
                        <div class="chat-title">Tech Store Support</div>
                        <div class="chat-subtitle"><div class="online-dot"></div> ƒêang ho·∫°t ƒë·ªông</div>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <button type="button" class="btn btn-sm text-danger border-0" onclick="clearHistory()" title="X√≥a l·ªãch s·ª≠ chat" style="background: none;">
                            <i class="bi bi-trash3-fill"></i>
                        </button>
                        <button type="button" class="btn-close" onclick="toggleChat()"></button>
                    </div>
                </div>
                
                <div class="chat-tabs">
                    <button class="chat-tab-btn active" onclick="switchTab('ai')" id="btn-ai">
                        <i class="bi bi-stars"></i> Tr·ª£ l√Ω AI
                    </button>
                    <button class="chat-tab-btn" onclick="switchTab('human')" id="btn-human">
                        <i class="bi bi-person-headset"></i> Nh√¢n vi√™n
                    </button>
                </div>
                
                <div class="tab-content">
                    
                    <div class="chat-pane active" id="pane-ai">
                        <div class="messages-area" id="msg-ai"></div>
                        <div class="typing-dot" id="typing-ai">AI ƒëang so·∫°n tin...</div>
                        <div class="input-area">
                            <input type="text" class="input-box" id="input-ai" placeholder="H·ªèi AI (V√≠ d·ª•: Laptop gaming)..." autocomplete="off" onkeypress="handleKey(event, 'ai')">
                            <button class="send-btn-icon" onclick="sendAI()"><i class="bi bi-send-fill"></i></button>
                        </div>
                    </div>
                    
                    <div class="chat-pane" id="pane-human">
                        <div class="messages-area" id="msg-human"></div>
                        <div class="input-area">
                            <input type="text" class="input-box" id="input-human" placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off" onkeypress="handleKey(event, 'human')">
                            <button class="send-btn-icon" onclick="sendHuman()"><i class="bi bi-send-fill"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        
        <script th:inline="javascript">
            // === 1. QU·∫¢N L√ù L·ªäCH S·ª¨ CHAT (LOCAL STORAGE) ===
            document.addEventListener("DOMContentLoaded", function() {
                loadHistory('ai');
                loadHistory('human');
            });

            function loadHistory(type) {
                let saved = localStorage.getItem('chat_history_' + type);
                let container = document.getElementById('msg-' + type);
                
                if (saved) {
                    container.innerHTML = saved;
                    scrollDown('msg-' + type);
                } else {
                    // N·∫øu ch∆∞a c√≥ l·ªãch s·ª≠ th√¨ hi·ªán c√¢u ch√†o m·∫∑c ƒë·ªãnh
                    if(type === 'ai') {
                        addMsg('msg-ai', 'Xin ch√†o! üëã Em l√† tr·ª£ l√Ω AI. Anh/ch·ªã c·∫ßn t√¨m s·∫£n ph·∫©m g√¨ ·∫°?', 'receiver', false);
                    } else {
                        container.innerHTML = '<div class="text-center small text-muted my-3">-- K·∫øt n·ªëi v·ªõi nh√¢n vi√™n --</div>';
                    }
                }
            }

            function saveHistory(type) {
                let content = document.getElementById('msg-' + type).innerHTML;
                localStorage.setItem('chat_history_' + type, content);
            }

            function clearHistory() {
                if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ tr√≤ chuy·ªán kh√¥ng?')) {
                    localStorage.removeItem('chat_history_ai');
                    localStorage.removeItem('chat_history_human');
                    location.reload(); // T·∫£i l·∫°i trang ƒë·ªÉ l√†m m·ªõi
                }
            }

            // === 2. LOGIC GIAO DI·ªÜN & CHUY·ªÇN TAB ===
            function switchTab(tab) {
                document.querySelectorAll('.chat-tab-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('btn-' + tab).classList.add('active');
                
                document.querySelectorAll('.chat-pane').forEach(p => p.classList.remove('active'));
                document.getElementById('pane-' + tab).classList.add('active');

                // N·∫øu l√† tab nh√¢n vi√™n -> K·∫øt n·ªëi WebSocket
                if(tab === 'human') connectHuman();
                
                // Focus v√†o √¥ nh·∫≠p
                setTimeout(() => document.getElementById('input-' + tab).focus(), 100);
            }

            function toggleChat() {
                let box = document.getElementById('chatBox');
                let icon = document.getElementById('toggleIcon');
                
                if(box.style.display === 'none' || !box.style.display) {
                    box.style.display = 'flex';
                    icon.classList.remove('bi-chat-fill');
                    icon.classList.add('bi-chevron-down');
                    document.getElementById('notiDot').style.display = 'none';
                    setTimeout(() => document.getElementById('input-ai').focus(), 300);
                } else {
                    box.style.display = 'none';
                    icon.classList.remove('bi-chevron-down');
                    icon.classList.add('bi-chat-fill');
                }
            }

            // === 3. LOGIC G·ª¨I TIN AI (G·ªåI API) ===
            async function sendAI() {
                let input = document.getElementById('input-ai');
                let txt = input.value.trim();
                if(!txt) return;

                addMsg('msg-ai', txt, 'sender'); // Hi·ªán tin nh·∫Øn c·ªßa m√¨nh
                input.value = '';
                
                let typing = document.getElementById('typing-ai');
                typing.style.display = 'block';
                scrollDown('msg-ai');

                try {
                    let res = await fetch('/api/bot/chat', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({message: txt})
                    });
                    let data = await res.json();
                    
                    typing.style.display = 'none';
                    addMsg('msg-ai', data.response, 'receiver'); // Hi·ªán c√¢u tr·∫£ l·ªùi
                } catch(e) {
                    typing.style.display = 'none';
                    addMsg('msg-ai', 'L·ªói k·∫øt n·ªëi AI! Vui l√≤ng th·ª≠ l·∫°i sau.', 'receiver');
                }
            }

            // === 4. LOGIC G·ª¨I TIN NH√ÇN VI√äN (WEBSOCKET) ===
            var stomp = null;
            var user = /*[[${session.user != null ? session.user.username : 'Guest_' + #dates.createNow().time}]]*/ 'Guest';

            function connectHuman() {
                if(stomp && stomp.connected) return;
                
                var socket = new SockJS('/ws');
                stomp = Stomp.over(socket);
                stomp.debug = null;

                stomp.connect({name: user}, function() {
                    addMsg('msg-human', 'ƒê√£ k·∫øt n·ªëi! B·∫°n c√≥ th·ªÉ chat ngay.', 'receiver');
                    
                    stomp.subscribe('/topic/private/' + user, function(payload) {
                        var body = JSON.parse(payload.body);
                        addMsg('msg-human', body.content, 'receiver');
                        
                        if(document.getElementById('chatBox').style.display === 'none') {
                            document.getElementById('notiDot').style.display = 'block';
                        }
                    });
                });
            }

            function sendHuman() {
                let input = document.getElementById('input-human');
                let txt = input.value.trim();
                if(!txt || !stomp) return;

                stomp.send("/app/chat.sendToAdmin", {}, JSON.stringify({
                    sender: user, receiver: 'Admin', content: txt, type: 'CHAT'
                }));
                
                addMsg('msg-human', txt, 'sender');
                input.value = '';
            }

            // === 5. C√ÅC H√ÄM H·ªñ TR·ª¢ CHUNG ===
            function addMsg(divId, txt, type, save = true) {
                let div = document.getElementById(divId);
                let msg = document.createElement('div');
                msg.className = 'msg ' + type;
                msg.innerHTML = txt.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                div.appendChild(msg);
                scrollDown(divId);
                
                if(save) {
                    let key = (divId === 'msg-ai') ? 'ai' : 'human';
                    saveHistory(key);
                }
            }

            function scrollDown(divId) {
                let div = document.getElementById(divId);
                div.scrollTop = div.scrollHeight;
            }

            function handleKey(e, type) {
                if(e.key === 'Enter') type === 'ai' ? sendAI() : sendHuman();
            }
        </script>
    </body>
</html>