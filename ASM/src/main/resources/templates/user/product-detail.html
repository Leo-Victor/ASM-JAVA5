<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{/layout/index :: dynamic(~{::main})}">
    <body>
        <main>
            <style>
                /* Khung ảnh chính */
                .product-image-box {
                    background: white;
                    border-radius: 20px;
                    padding: 20px;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.08);
                    display: flex; align-items: center; justify-content: center;
                    overflow: hidden; position: relative;
                    border: 1px solid #f0f0f0;
                }
                .main-img {
                    max-width: 100%; max-height: 450px;
                    transition: transform 0.5s ease;
                    object-fit: contain;
                }
                .product-image-box:hover .main-img { transform: scale(1.08); }

                /* Thông tin sản phẩm */
                .product-title { font-weight: 800; color: #333; line-height: 1.3; }
                .price-badge {
                    background: linear-gradient(135deg, #dc3545 0%, #ff6b6b 100%);
                    color: white; padding: 10px 20px; border-radius: 12px;
                    display: inline-block; box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
                }
                
                /* Chính sách (Policy) */
                .policy-box {
                    background: #f8f9fa; border-radius: 15px; padding: 20px;
                    border: 1px dashed #dee2e6;
                }
                .policy-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-size: 0.95rem; color: #555; }
                .policy-item i { color: #0d6efd; font-size: 1.2rem; }

                /* Nút bấm CTA */
                .btn-action {
                    padding: 12px 25px; border-radius: 50px; font-weight: 700;
                    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                    border: none; position: relative; overflow: hidden;
                }
                .btn-cart { background-color: #e7f1ff; color: #0d6efd; }
                .btn-cart:hover { background-color: #d0e4ff; transform: translateY(-3px); }
                
                .btn-buy {
                    background: linear-gradient(135deg, #0d6efd 0%, #0043a8 100%);
                    color: white; box-shadow: 0 5px 15px rgba(13, 110, 253, 0.4);
                }
                .btn-buy:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(13, 110, 253, 0.6); color: white; }

                /* Hiệu ứng ảnh bay (Giữ nguyên logic cũ nhưng chỉnh style) */
                .flying-img {
                    position: fixed; z-index: 9999; border-radius: 50%;
                    object-fit: cover; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
                    transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1);
                    pointer-events: none; border: 2px solid white;
                }
                
                /* Rung giỏ hàng */
                @keyframes shakeCart {
                    0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-15deg); } 75% { transform: rotate(15deg); }
                }
                .cart-shake { animation: shakeCart 0.5s ease-in-out; }
            </style>
            
            <div class="container mt-5 mb-5 animate__animated animate__fadeIn">
                <nav aria-label="breadcrumb" class="mb-4">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/home/index" class="text-decoration-none text-muted">Trang chủ</a></li>
                        <li class="breadcrumb-item"><a href="#" class="text-decoration-none text-muted">Danh mục</a></li>
                        <li class="breadcrumb-item active fw-bold text-primary" aria-current="page" th:text="${item.name}">Tên SP</li>
                    </ol>
                </nav>
                
                <div class="row g-5">
                    <div class="col-lg-5">
                        <div class="product-image-box">
                            <span class="position-absolute top-0 start-0 m-3 badge bg-danger fs-6 rounded-pill px-3 py-2 z-2">-15%</span>
                            
                            <img id="product-image"
                                 th:src="@{|/images/${item.image}|}"
                                 class="main-img"
                                 alt="Product Image"
                                 onerror="this.onerror=null; this.src='https://via.placeholder.com/500x500?text=No+Image';">
                        </div>
                    </div>
                    
                    <div class="col-lg-7">
                        <h2 class="display-6 product-title mb-3" th:text="${item.name}">Laptop Gaming XYZ</h2>
                        
                        <div class="d-flex align-items-center mb-4">
                            <div class="text-warning me-3">
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-half"></i>
                                <span class="text-muted ms-1 small">(4.8/5 đánh giá)</span>
                            </div>
                            <span class="text-muted border-start ps-3 small">Mã SP: <strong class="text-dark">#[[${item.id}]]</strong></span>
                            <span class="text-muted border-start ps-3 ms-3 small">Loại: <strong class="text-primary">[[${item.category.name}]]</strong></span>
                        </div>
                        
                        <div class="mb-4">
                            <h1 class="price-badge mb-0">
                                [[${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')}]] ₫
                            </h1>
                            <span class="text-decoration-line-through text-muted ms-3 fs-5">
                                [[${#numbers.formatDecimal(item.price * 1.15, 0, 'COMMA', 0, 'POINT')}]] ₫
                            </span>
                        </div>
                        
                        <p class="text-secondary mb-4" style="line-height: 1.6;">
                            Sản phẩm chính hãng, hiệu năng vượt trội. Thiết kế hiện đại, phù hợp cho mọi nhu cầu công việc và giải trí.
                            Đặt hàng ngay hôm nay để nhận ưu đãi đặc biệt.
                        </p>
                        
                        <div class="policy-box mb-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="policy-item"><i class="bi bi-shield-check"></i> Bảo hành chính hãng 12 tháng</div>
                                    <div class="policy-item"><i class="bi bi-arrow-repeat"></i> 1 đổi 1 trong 30 ngày</div>
                                </div>
                                <div class="col-md-6">
                                    <div class="policy-item"><i class="bi bi-truck"></i> Freeship toàn quốc</div>
                                    <div class="policy-item"><i class="bi bi-gift"></i> Tặng kèm Balo cao cấp</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-3">
                            <button th:onclick="'addToCart(' + ${item.id} + ')'"
                                    class="btn btn-cart btn-action flex-grow-1">
                                <i class="bi bi-cart-plus-fill me-2"></i> THÊM VÀO GIỎ
                            </button>
                            
                            <a th:href="@{|/cart/buy/${item.id}|}"
                               class="btn btn-buy btn-action flex-grow-1 text-center text-decoration-none">
                                <i class="bi bi-lightning-charge-fill me-2"></i> MUA NGAY
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="mt-5 pt-5 border-top">
                    <h4 class="fw-bold mb-4 text-uppercase text-primary"><i class="bi bi-stars"></i> Có thể bạn sẽ thích</h4>
                    <div class="row row-cols-1 row-cols-md-4 g-4">
                        <div class="col" th:each="i : ${#numbers.sequence(1, 4)}">
                            <div class="card h-100 border-0 shadow-sm" style="border-radius: 15px; opacity: 0.7;">
                                <div class="card-body text-center py-5">
                                    <i class="bi bi-image text-muted fs-1"></i>
                                    <p class="text-muted mt-2 small">Sản phẩm gợi ý (Coming Soon)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <script>
                function addToCart(productId) {
                    fetch('/api/cart/add/' + productId)
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'error') {
                                window.location.href = "/account/login?message=" + encodeURIComponent(data.message);
                            } else {
                                flyToCart(data.count);
                            }
                        })
                        .catch(error => console.error('Lỗi:', error));
                }
            
                function flyToCart(newCount) {
                    const productImg = document.getElementById('product-image');
                    const cartIcon = document.getElementById('cart-icon-container'); // ID này ở trong fragments.html
                    const cartCountBadge = document.getElementById('cart-count'); // ID này ở trong fragments.html
            
                    if (!productImg || !cartIcon) return;
            
                    const flyImg = productImg.cloneNode();
                    flyImg.classList.add('flying-img');
                    
                    const startRect = productImg.getBoundingClientRect();
                    const endRect = cartIcon.getBoundingClientRect();
            
                    flyImg.style.top = startRect.top + 'px';
                    flyImg.style.left = startRect.left + 'px';
                    flyImg.style.width = startRect.width + 'px';
                    flyImg.style.height = startRect.height + 'px';
                    
                    document.body.appendChild(flyImg);
            
                    setTimeout(() => {
                        flyImg.style.top = (endRect.top + 10) + 'px';
                        flyImg.style.left = (endRect.left + 10) + 'px';
                        flyImg.style.width = '30px';
                        flyImg.style.height = '30px';
                        flyImg.style.opacity = '0';
                    }, 10);
            
                    setTimeout(() => {
                        flyImg.remove();
                        if(cartCountBadge) {
                            cartCountBadge.innerText = newCount;
                            cartCountBadge.classList.add('animate__animated', 'animate__heartBeat');
                            setTimeout(() => cartCountBadge.classList.remove('animate__animated', 'animate__heartBeat'), 1000);
                        }
                    }, 800);
                }
            </script>
        </main>
    </body>
</html>